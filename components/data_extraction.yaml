# PIPELINE DEFINITION
# Name: data-extraction
# Description: Component 1: Data Extraction
#              Fetches the versioned California Housing dataset
#              
#              This component simulates DVC data fetching by loading the California Housing dataset.
#              In a real scenario, it would use 'dvc get' or 'dvc import' to fetch versioned data.
#              
#              Outputs:
#                  dataset_output (Output[Dataset]): Raw dataset saved as CSV file
#                      - Contains 20,640 samples
#                      - 8 features + 1 target variable (PRICE)
#                      - Saved to path provided by Kubeflow
# Outputs:
#    dataset_output: system.Dataset
components:
  comp-data-extraction:
    executorLabel: exec-data-extraction
    outputDefinitions:
      artifacts:
        dataset_output:
          artifactType:
            schemaTitle: system.Dataset
            schemaVersion: 0.0.1
deploymentSpec:
  executors:
    exec-data-extraction:
      container:
        args:
        - --executor_input
        - '{{$}}'
        - --function_to_execute
        - data_extraction
        command:
        - sh
        - -c
        - "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip ||\
          \ python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1\
          \ python3 -m pip install --quiet --no-warn-script-location 'pandas==2.0.3'\
          \ 'scikit-learn==1.3.0' 'numpy==1.24.3' 'dvc==3.30.0'  &&  python3 -m pip\
          \ install --quiet --no-warn-script-location 'kfp==2.15.1' '--no-deps' 'typing-extensions>=3.7.4,<5;\
          \ python_version<\"3.9\"' && \"$0\" \"$@\"\n"
        - sh
        - -ec
        - 'program_path=$(mktemp -d)


          printf "%s" "$0" > "$program_path/ephemeral_component.py"

          _KFP_RUNTIME=true python3 -m kfp.dsl.executor_main                         --component_module_path                         "$program_path/ephemeral_component.py"                         "$@"

          '
        - "\nimport kfp\nfrom kfp import dsl\nfrom kfp.dsl import *\nfrom typing import\
          \ *\n\ndef data_extraction(\n    dataset_output: Output[Dataset]\n):\n \
          \   \"\"\"\n    Component 1: Data Extraction\n    Fetches the versioned\
          \ California Housing dataset\n\n    This component simulates DVC data fetching\
          \ by loading the California Housing dataset.\n    In a real scenario, it\
          \ would use 'dvc get' or 'dvc import' to fetch versioned data.\n\n    Outputs:\n\
          \        dataset_output (Output[Dataset]): Raw dataset saved as CSV file\n\
          \            - Contains 20,640 samples\n            - 8 features + 1 target\
          \ variable (PRICE)\n            - Saved to path provided by Kubeflow\n \
          \   \"\"\"\n    import pandas as pd\n    from sklearn.datasets import fetch_california_housing\n\
          \    import warnings\n    warnings.filterwarnings('ignore')\n\n    print(\"\
          =\" * 70)\n    print(\"COMPONENT 1: DATA EXTRACTION\")\n    print(\"=\"\
          \ * 70)\n    print(\"Fetching California Housing dataset...\")\n    print(\"\
          (In production, this would use: dvc get or dvc import)\")\n\n    # Load\
          \ California Housing dataset\n    # NOTE: In real scenario, you would use:\n\
          \    # subprocess.run([\"dvc\", \"get\", \".\", \"data/raw_data.csv\", \"\
          -o\", dataset_output.path])\n    housing = fetch_california_housing()\n\
          \    df = pd.DataFrame(housing.data, columns=housing.feature_names)\n  \
          \  df['PRICE'] = housing.target\n\n    # Save extracted data\n    df.to_csv(dataset_output.path,\
          \ index=False)\n\n    print(f\"\\n\u2713 Data extraction completed!\")\n\
          \    print(f\"\u2713 Dataset shape: {df.shape}\")\n    print(f\"\u2713 Total\
          \ samples: {df.shape[0]:,}\")\n    print(f\"\u2713 Total features: {df.shape[1]\
          \ - 1}\")\n    print(f\"\u2713 Features: {list(df.columns)}\")\n    print(f\"\
          \u2713 Target variable: PRICE (median house value)\")\n    print(f\"\u2713\
          \ Data saved to: {dataset_output.path}\")\n    print(\"=\" * 70)\n\n"
        image: python:3.9
pipelineInfo:
  name: data-extraction
root:
  dag:
    outputs:
      artifacts:
        dataset_output:
          artifactSelectors:
          - outputArtifactKey: dataset_output
            producerSubtask: data-extraction
    tasks:
      data-extraction:
        cachingOptions:
          enableCache: true
        componentRef:
          name: comp-data-extraction
        taskInfo:
          name: data-extraction
  outputDefinitions:
    artifacts:
      dataset_output:
        artifactType:
          schemaTitle: system.Dataset
          schemaVersion: 0.0.1
schemaVersion: 2.1.0
sdkVersion: kfp-2.15.1
